<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>Donate</title>
    <link rel="stylesheet" href="./styles/site.css" />
</head>
<body class="page page--donate">
<modular-menu
      data-links='[
        {"label":"Home","href":"./index.html"},
        {"label":"About Us","href":"./aboutus.html"},
        {"label":"Resources","href":"./resources.html"},
        {"label":"Contact","href":"./contact.html"},
        {"label":"Community Engagement","href":"./community.html"},
        {"label":"Donate","href":"./donate.html"},
        {"label":"Merch Store","href":"./shop.html"}
      ]'
></modular-menu>

<main id="donate" class="text-center">
    <h1>Donate Today</h1>
    <p>
        TMH is a 501(c)(3) registered in the United States.
        The money you donate goes towards:
    </p>

    <div class="resource-grid">
        <article class="resource-card">
            <h3>Operational Costs</h3>
            <p>
                Helps keep TMH running, covering the day-to-day
                expenses to community programs for TMH members.
            </p>
        </article>
        <article class="resource-card">
            <h3>Emergency Funds</h3>
            <p>
                Life has unexpected turn for everyone, and TMH
                provides resources to help its members when they need it most.
            </p>
        </article>
        <article class="resource-card">
            <h3>Projects</h3>
            <p>
                TMH hosts multiple projects aimed at helping members
                improve their quality of life.
            </p>
        </article>
    </div>

    <p>
        For more details about what your donations can do for TMH, you can check <br>
        our full breakdown here. <!--Add a link when we have an official document certified !-->
    </p>
    <p>
        Donations are processed temporarily Venmo. Fill out the form below and you'll be redirected
        to complete your contribution.
    </p>
</main>

<form id="donateForm" class="card" data-venmo-handle="cn1731">
    <div>
        <label for="donor-first-name">First Name</label>
        <input id="donor-first-name" name="firstName" type="text" required placeholder="First Name" />
    </div>
    <div>
        <label for="donor-last-name">Last Name</label>
        <input id="donor-last-name" name="lastName" type="text" required placeholder="Last Name" />
    </div>
    <div>
        <label for="email">Email</label>
        <input id="email" name="email" type="email" required placeholder="Email" />
    </div>
    <div>
        <label for="donation-amount">Donation Amount (USD)</label>
        <input
            id="donation-amount"
            name="amount"
            type="number"
            inputmode="decimal"
            min="1"
            step="0.01"
            required
            placeholder="25.00"
        />
    </div>
    <div>
        <label for="donation-message">Note (optional)</label>
        <textarea id="donation-message" name="message" placeholder="Share a note for TMH."></textarea>
    </div>
    <p class="status" id="venmoHandleDisplay" aria-live="polite"></p>
    <button type="submit">Continue to Venmo</button>
    <p class="status" id="statusText" role="status" aria-live="polite"></p>
</form>

<script src="./scripts/menu-component.js"></script>
<script>
    (() => {
        const form = document.getElementById("donateForm");
        if (!form) {
            return;
        }

        const status = document.getElementById("statusText");
        const handleDisplay = document.getElementById("venmoHandleDisplay");
        const firstNameInput = document.getElementById("donor-first-name");
        const lastNameInput = document.getElementById("donor-last-name");
        const emailInput = document.getElementById("email");
        const amountInput = document.getElementById("donation-amount");
        const messageInput = document.getElementById("donation-message");

        const updateStatus = (message, variant) => {
            if (!status) {
                return;
            }
            status.textContent = message;
            status.className = variant ? `status ${variant}` : "status";
        };

        const normalizeHandle = (handle) => handle.replace(/^@/, "");
        const rawHandle = form.dataset.venmoHandle ? form.dataset.venmoHandle.trim() : "";
        const venmoHandle = rawHandle ? normalizeHandle(rawHandle) : "";

        if (handleDisplay) {
            handleDisplay.textContent = venmoHandle
                ? `Venmo: @${venmoHandle}`
                : "Venmo handle not set yet. Update this page with your handle.";
        }

        const buildNote = ({ firstName, lastName, email, message }) => {
            const identity = [firstName, lastName].filter(Boolean).join(" ").trim();
            const parts = ["TMH Donation"];
            if (identity) {
                parts.push(identity);
            }
            if (email) {
                parts.push(email);
            }
            if (message) {
                parts.push(message);
            }

            let note = parts.join(" - ");
            if (note.length > 240) {
                note = `${note.slice(0, 237)}...`;
            }
            return note;
        };

        form.addEventListener("submit", (event) => {
            event.preventDefault();
            updateStatus("", "");

            if (!venmoHandle) {
                updateStatus("Venmo handle missing. Please update the form configuration.", "error");
                return;
            }

            const amountValue = amountInput ? Number.parseFloat(amountInput.value) : NaN;
            if (!Number.isFinite(amountValue) || amountValue <= 0) {
                updateStatus("Enter a valid donation amount.", "error");
                return;
            }

            const note = buildNote({
                firstName: firstNameInput ? firstNameInput.value.trim() : "",
                lastName: lastNameInput ? lastNameInput.value.trim() : "",
                email: emailInput ? emailInput.value.trim() : "",
                message: messageInput ? messageInput.value.trim() : ""
            });

            const venmoUrl = new URL("https://venmo.com/");
            venmoUrl.searchParams.set("txn", "pay");
            venmoUrl.searchParams.set("recipients", venmoHandle);
            venmoUrl.searchParams.set("amount", amountValue.toFixed(2));
            venmoUrl.searchParams.set("note", note);

            updateStatus("Redirecting to Venmo...", "success");
            window.location.href = venmoUrl.toString();
        });
    })();
</script>
</body>
</html>
